{% extends "base.html" %}
{% block title %}è²ªåƒè›‡éŠæˆ²{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 mx-auto text-center">
            <h2>ğŸ è²ªåƒè›‡éŠæˆ²</h2>
            
            <!-- éŠæˆ²è³‡è¨Š -->
            <div class="row mb-3">
                <div class="col-3">
                    <div class="card">
                        <div class="card-body p-2">
                            <small class="text-muted">åˆ†æ•¸</small>
                            <h5 id="score">0</h5>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body p-2">
                            <small class="text-muted">æœ€é«˜åˆ†</small>
                            <h5 id="highScore">0</h5>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body p-2">
                            <small class="text-muted">ç”Ÿå‘½</small>
                            <h5 id="lives">0</h5>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body p-2">
                            <small class="text-muted">æ­»äº¡</small>
                            <h5 id="deaths">0</h5>
                        </div>
                    </div>
                </div>
            </div>

            <!-- éŠæˆ²ç•«å¸ƒ -->
            <div class="game-container mb-3">
                <canvas id="gameCanvas" width="600" height="400"></canvas>
            </div>

            <!-- æ§åˆ¶æŒ‰éˆ• -->
            <div class="controls mb-3">
                <button id="startBtn" class="btn btn-success me-2">é–‹å§‹éŠæˆ²</button>
                <button id="pauseBtn" class="btn btn-warning me-2" disabled>æš«åœ</button>
                <button id="resetBtn" class="btn btn-danger me-2">é‡æ–°é–‹å§‹</button>
                <a href="{{ url_for('game.game_menu') }}" class="btn btn-secondary">è¿”å›é¸å–®</a>
            </div>

            <!-- æ§åˆ¶èªªæ˜ -->
            <div class="card">
                <div class="card-body">
                    <h6>æ§åˆ¶èªªæ˜</h6>
                    <p class="mb-0">
                        <kbd>â†‘</kbd> <kbd>â†“</kbd> <kbd>â†</kbd> <kbd>â†’</kbd> æ§åˆ¶æ–¹å‘ |
                        <span class="text-success">ç¶ è‰²é£Ÿç‰©</span> +1åˆ† |
                        <span class="color: #388aff">è—è‰²è­·èº«ç¬¦</span> +1ç”Ÿå‘½ |
                        <span class="text-danger">ç´…è‰²ç‚¸å½ˆ</span> -1ç”Ÿå‘½
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.game-container {
    display: flex;
    justify-content: center;
    align-items: center;
}

#gameCanvas {
    border: 2px solid #333;
    background-color: #000;
}

.controls button {
    min-width: 100px;
}
</style>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreElement = document.getElementById('score');
const highScoreElement = document.getElementById('highScore');
const livesElement = document.getElementById('lives');
const deathsElement = document.getElementById('deaths');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resetBtn = document.getElementById('resetBtn');

// éŠæˆ²å¸¸æ•¸
const CELL_SIZE = 20;
const COLS = canvas.width / CELL_SIZE;
const ROWS = canvas.height / CELL_SIZE;
const FPS = 10;

// éŠæˆ²è®Šæ•¸
let gameRunning = false;
let gamePaused = false;
let gameLoop;
let snake = [];
let direction = { x: 1, y: 0 };
let score = 0;
let highScore = 0;
let lives = 0;
let deaths = 0;
let foods = [];
let bombs = [];

// åˆå§‹åŒ–éŠæˆ²
function initGame() {
    snake = [
        { x: 5, y: 10 },
        { x: 4, y: 10 },
        { x: 3, y: 10 }
    ];
    direction = { x: 1, y: 0 };
    score = 0;
    lives = 0;
    foods = [];
    bombs = [];
    spawnFood();
    updateDisplay();
}

function spawnFood() {
    // ç”Ÿæˆæ™®é€šé£Ÿç‰©
    for (let i = 0; i < 2; i++) {
        const food = {
            x: Math.floor(Math.random() * COLS),
            y: Math.floor(Math.random() * ROWS),
            type: 'normal'
        };
        foods.push(food);
    }
    
    // 20% æ©Ÿç‡ç”Ÿæˆè­·èº«ç¬¦
    if (Math.random() < 0.2) {
        const shield = {
            x: Math.floor(Math.random() * COLS),
            y: Math.floor(Math.random() * ROWS),
            type: 'shield'
        };
        foods.push(shield);
    }
}

function spawnBomb() {
    if (Math.random() < 0.02) {
        const bomb = {
            x: Math.floor(Math.random() * COLS),
            y: Math.floor(Math.random() * ROWS),
            timer: FPS * 4
        };
        bombs.push(bomb);
    }
}

function draw() {
    // æ¸…ç©ºç•«å¸ƒ
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // ç•«è›‡
    ctx.fillStyle = '#0f0';
    snake.forEach(segment => {
        ctx.fillRect(segment.x * CELL_SIZE, segment.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
    });
    
    // ç•«é£Ÿç‰©
    foods.forEach(food => {
        ctx.fillStyle = food.type === 'normal' ? '#ff0' : '#00f';
        ctx.fillRect(food.x * CELL_SIZE, food.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
    });
    
    // ç•«ç‚¸å½ˆ
    ctx.fillStyle = '#f00';
    bombs.forEach(bomb => {
        ctx.fillRect(bomb.x * CELL_SIZE, bomb.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
    });
}

function update() {
    if (!gameRunning || gamePaused) return;
    
    // ç§»å‹•è›‡
    const head = { ...snake[0] };
    head.x += direction.x;
    head.y += direction.y;
    
    // æª¢æŸ¥ç¢°æ’
    let died = false;
    
    // æ’ç‰†æˆ–æ’è‡ªå·±
    if (head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS || 
        snake.some(segment => segment.x === head.x && segment.y === head.y)) {
        if (lives > 0) {
            lives--;
            // å˜—è©¦é¿é–‹éšœç¤™
            const alternatives = [
                { x: 1, y: 0 }, { x: -1, y: 0 }, { x: 0, y: 1 }, { x: 0, y: -1 }
            ];
            let found = false;
            for (let newDir of alternatives) {
                if (newDir.x === -direction.x && newDir.y === -direction.y) continue;
                const newHead = { x: snake[0].x + newDir.x, y: snake[0].y + newDir.y };
                if (newHead.x >= 0 && newHead.x < COLS && newHead.y >= 0 && newHead.y < ROWS &&
                    !snake.some(segment => segment.x === newHead.x && segment.y === newHead.y)) {
                    direction = newDir;
                    head.x = newHead.x;
                    head.y = newHead.y;
                    found = true;
                    break;
                }
            }
            if (!found) died = true;
        } else {
            died = true;
        }
    }
    
    if (!died) {
        snake.unshift(head);
        
        // æª¢æŸ¥åƒé£Ÿç‰©
        let ate = false;
        foods = foods.filter(food => {
            if (food.x === head.x && food.y === head.y) {
                if (food.type === 'normal') {
                    score++;
                } else if (food.type === 'shield') {
                    lives++;
                }
                ate = true;
                return false;
            }
            return true;
        });
        
        // æª¢æŸ¥ç‚¸å½ˆ
        bombs = bombs.filter(bomb => {
            if (bomb.x === head.x && bomb.y === head.y) {
                if (lives > 0) {
                    lives--;
                    return false;
                } else {
                    died = true;
                    return true;
                }
            }
            bomb.timer--;
            return bomb.timer > 0;
        });
        
        if (!ate) {
            snake.pop();
        }
    }
    
    if (died) {
        deaths++;
        if (score > highScore) {
            highScore = score;
        }
        
        // å„²å­˜åˆ†æ•¸
        saveScore();
        
        setTimeout(() => {
            if (confirm(`éŠæˆ²çµæŸï¼åˆ†æ•¸: ${score}\næ˜¯å¦é‡æ–°é–‹å§‹ï¼Ÿ`)) {
                resetGame();
                startGame();
            } else {
                stopGame();
            }
        }, 100);
        return;
    }
    
    // ç”Ÿæˆæ–°é£Ÿç‰©å’Œç‚¸å½ˆ
    if (foods.length < 3) {
        spawnFood();
    }
    spawnBomb();
    
    updateDisplay();
}

function updateDisplay() {
    scoreElement.textContent = score;
    highScoreElement.textContent = highScore;
    livesElement.textContent = lives;
    deathsElement.textContent = deaths;
}

function startGame() {
    if (!gameRunning) {
        gameRunning = true;
        gameLoop = setInterval(() => {
            update();
            draw();
        }, 1000 / FPS);
        startBtn.disabled = true;
        pauseBtn.disabled = false;
    }
}

function pauseGame() {
    gamePaused = !gamePaused;
    pauseBtn.textContent = gamePaused ? 'ç¹¼çºŒ' : 'æš«åœ';
}

function stopGame() {
    gameRunning = false;
    gamePaused = false;
    if (gameLoop) {
        clearInterval(gameLoop);
    }
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    pauseBtn.textContent = 'æš«åœ';
}

function resetGame() {
    stopGame();
    initGame();
    draw();
}

function saveScore() {
    fetch('/game/save_score', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            game_type: 'snake',
            score: score,
            level: 1
        })
    });
}

// äº‹ä»¶ç›£è½
document.addEventListener('keydown', (e) => {
    if (!gameRunning || gamePaused) return;
    
    switch (e.key) {
        case 'ArrowUp':
            if (direction.y === 0) direction = { x: 0, y: -1 };
            break;
        case 'ArrowDown':
            if (direction.y === 0) direction = { x: 0, y: 1 };
            break;
        case 'ArrowLeft':
            if (direction.x === 0) direction = { x: -1, y: 0 };
            break;
        case 'ArrowRight':
            if (direction.x === 0) direction = { x: 1, y: 0 };
            break;
    }
});

startBtn.addEventListener('click', startGame);
pauseBtn.addEventListener('click', pauseGame);
resetBtn.addEventListener('click', resetGame);

// åˆå§‹åŒ–
initGame();
draw();
</script>
{% endblock %}