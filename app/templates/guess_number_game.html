{% extends "base.html" %}

{% block title %}çŒœæ•¸å­—éŠæˆ²{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-warning text-dark text-center">
                    <h3><i class="fas fa-brain"></i> çŒœæ•¸å­—éŠæˆ²</h3>
                </div>
                <div class="card-body text-center">
                    <!-- éŠæˆ²å€åŸŸ -->
                    <div id="gameArea">
                        <div class="mb-4">
                            <h4 class="text-primary">æˆ‘æƒ³äº†ä¸€å€‹ 1 åˆ° 100 ä¹‹é–“çš„æ•¸å­—</h4>
                            <p class="text-muted">ä½ èƒ½ç”¨æœ€å°‘çš„æ¬¡æ•¸çŒœå‡ºä¾†å—ï¼Ÿ</p>
                        </div>
                        
                        <!-- è¼¸å…¥å€åŸŸ -->
                        <div class="mb-4">
                            <div class="input-group justify-content-center">
                                <input type="number" id="guessInput" class="form-control text-center" 
                                       placeholder="è¼¸å…¥ä½ çš„çŒœæ¸¬ (1-100)" min="1" max="100" style="max-width: 200px;">
                                <button id="submitGuess" class="btn btn-primary">çŒœï¼</button>
                            </div>
                        </div>
                        
                        <!-- æç¤ºå€åŸŸ -->
                        <div id="hintArea" class="mb-4">
                            <div id="hintMessage" class="alert alert-info" style="display: none;"></div>
                        </div>
                        
                        <!-- éŠæˆ²çµ±è¨ˆ -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <h5>å˜—è©¦æ¬¡æ•¸: <span id="attempts">0</span></h5>
                            </div>
                            <div class="col-md-4">
                                <h5>æœ€ä½³è¨˜éŒ„: <span id="bestScore">-</span></h5>
                            </div>
                            <div class="col-md-4">
                                <h5>å‰©é¤˜ç¯„åœ: <span id="range">1-100</span></h5>
                            </div>
                        </div>
                        
                        <!-- çŒœæ¸¬æ­·å² -->
                        <div id="historyArea" style="display: none;">
                            <h6>çŒœæ¸¬æ­·å²ï¼š</h6>
                            <div id="guessHistory" class="d-flex flex-wrap justify-content-center gap-2 mb-3"></div>
                        </div>
                    </div>
                    
                    <!-- éŠæˆ²æ§åˆ¶ -->
                    <div class="mb-3">
                        <button id="newGameBtn" class="btn btn-success me-2">æ–°éŠæˆ²</button>
                        <button id="giveUpBtn" class="btn btn-danger me-2">æ”¾æ£„</button>
                        <a href="{{ url_for('game.game_menu') }}" class="btn btn-secondary">è¿”å›é¸å–®</a>
                    </div>
                    
                    <!-- éŠæˆ²èªªæ˜ -->
                    <div class="mt-3">
                        <small class="text-muted">
                            ğŸ¯ ç›®æ¨™ï¼šç”¨æœ€å°‘çš„æ¬¡æ•¸çŒœå‡ºæ•¸å­—<br>
                            ğŸ’¯ åˆ†æ•¸è¨ˆç®—ï¼š(101 - å˜—è©¦æ¬¡æ•¸) Ã— 10<br>
                            ğŸ† å®Œç¾åˆ†æ•¸ï¼š1000åˆ†ï¼ˆ1æ¬¡çŒœä¸­ï¼‰
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- éŠæˆ²çµæŸæ¨¡æ…‹æ¡† -->
<div class="modal fade" id="gameOverModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                <h5 class="modal-title" id="modalTitle">éŠæˆ²çµæŸ</h5>
            </div>
            <div class="modal-body text-center">
                <div id="resultMessage"></div>
                <h4>ç­”æ¡ˆæ˜¯ï¼š<span id="correctAnswer">?</span></h4>
                <p>å˜—è©¦æ¬¡æ•¸ï¼š<span id="finalAttempts">0</span></p>
                <p>å¾—åˆ†ï¼š<span id="finalScore">0</span></p>
                <div id="scoreRating" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                <button type="button" class="btn btn-primary" id="playAgainBtn">å†ç©ä¸€æ¬¡</button>
            </div>
        </div>
    </div>
</div>

<script>
class GuessNumberGame {
    constructor() {
        this.targetNumber = 0;
        this.attempts = 0;
        this.minRange = 1;
        this.maxRange = 100;
        this.guessHistory = [];
        this.gameOver = false;
        this.bestScore = this.loadBestScore();
        
        this.bindEvents();
        this.newGame();
        this.updateBestScore();
    }
    
    bindEvents() {
        // è¼¸å…¥æ¡†å›è»Šäº‹ä»¶
        document.getElementById('guessInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.makeGuess();
            }
        });
        
        // æŒ‰éˆ•äº‹ä»¶
        document.getElementById('submitGuess').addEventListener('click', () => this.makeGuess());
        document.getElementById('newGameBtn').addEventListener('click', () => this.newGame());
        document.getElementById('giveUpBtn').addEventListener('click', () => this.giveUp());
        document.getElementById('playAgainBtn').addEventListener('click', () => this.newGame());
    }
    
    newGame() {
        this.targetNumber = Math.floor(Math.random() * 100) + 1;
        this.attempts = 0;
        this.minRange = 1;
        this.maxRange = 100;
        this.guessHistory = [];
        this.gameOver = false;
        
        // é‡ç½®UI
        document.getElementById('guessInput').value = '';
        document.getElementById('guessInput').disabled = false;
        document.getElementById('submitGuess').disabled = false;
        document.getElementById('hintMessage').style.display = 'none';
        document.getElementById('historyArea').style.display = 'none';
        
        // é—œé–‰æ¨¡æ…‹æ¡†
        const modal = bootstrap.Modal.getInstance(document.getElementById('gameOverModal'));
        if (modal) modal.hide();
        
        this.updateUI();
        console.log('æ–°éŠæˆ²é–‹å§‹ï¼Œç­”æ¡ˆæ˜¯ï¼š', this.targetNumber); // é–‹ç™¼æ™‚å¯ä»¥çœ‹ç­”æ¡ˆ
    }
    
    makeGuess() {
        if (this.gameOver) return;
        
        const input = document.getElementById('guessInput');
        const guess = parseInt(input.value);
        
        // é©—è­‰è¼¸å…¥
        if (isNaN(guess) || guess < 1 || guess > 100) {
            this.showHint('è«‹è¼¸å…¥ 1 åˆ° 100 ä¹‹é–“çš„æ•¸å­—ï¼', 'danger');
            return;
        }
        
        if (guess < this.minRange || guess > this.maxRange) {
            if (this.minRange === this.maxRange) {
                this.showHint(`æ ¹æ“šä¹‹å‰çš„çŒœæ¸¬ï¼Œç­”æ¡ˆåªèƒ½æ˜¯ ${this.minRange}ï¼`, 'info');
            } else {
                this.showHint(`è«‹è¼¸å…¥ ${this.minRange} åˆ° ${this.maxRange} ä¹‹é–“çš„æ•¸å­—ï¼`, 'danger');
            }
            return;
        }
        
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“çŒœé
        if (this.guessHistory.some(h => h.number === guess)) {
            this.showHint('ä½ å·²ç¶“çŒœéé€™å€‹æ•¸å­—äº†ï¼', 'warning');
            return;
        }
        
        this.attempts++;
        input.value = '';
        
        // åˆ¤æ–·çŒœæ¸¬çµæœ
        let result, hintClass;
        if (guess === this.targetNumber) {
            result = 'correct';
            this.showHint('ğŸ‰ æ­å–œä½ ï¼çŒœå°äº†ï¼', 'success');
            this.gameWin();
        } else if (guess < this.targetNumber) {
            result = 'low';
            this.minRange = Math.max(this.minRange, guess + 1);
            this.showHint(`å¤ªå°äº†ï¼æ•¸å­—æ¯” ${guess} å¤§`, 'info');
        } else {
            result = 'high';
            this.maxRange = Math.min(this.maxRange, guess - 1);
            this.showHint(`å¤ªå¤§äº†ï¼æ•¸å­—æ¯” ${guess} å°`, 'info');
        }
        
        // è¨˜éŒ„çŒœæ¸¬æ­·å²
        this.guessHistory.push({
            number: guess,
            result: result,
            attempt: this.attempts
        });
        
        this.updateUI();
        this.updateHistory();
        
        // æª¢æŸ¥ç¯„åœé‚è¼¯
        if (this.minRange > this.maxRange && result !== 'correct') {
            this.showHint('ç¯„åœå‡ºç¾å•é¡Œï¼Œé‡æ–°é–‹å§‹ï¼', 'danger');
            setTimeout(() => this.newGame(), 2000);
        } else if (this.minRange === this.maxRange && result !== 'correct') {
            // ç•¶ç¯„åœç¸®å°åˆ°åªå‰©ä¸€å€‹æ•¸å­—æ™‚ï¼Œè‡ªå‹•çµæŸéŠæˆ²
            setTimeout(() => {
                this.showHint(`æ ¹æ“šé‚è¼¯æ¨å°ï¼Œç­”æ¡ˆæ˜¯ ${this.minRange}ï¼`, 'success');
                this.gameWin();
            }, 1000);
        }
    }
    
    gameWin() {
        this.gameOver = true;
        const score = this.calculateScore();
        
        // æ›´æ–°æœ€ä½³è¨˜éŒ„
        if (score > this.bestScore) {
            this.bestScore = score;
            this.saveBestScore(score);
            this.updateBestScore();
        }
        
        // ç¦ç”¨è¼¸å…¥
        document.getElementById('guessInput').disabled = true;
        document.getElementById('submitGuess').disabled = true;
        
        // å»¶é²é¡¯ç¤ºçµæœæ¨¡æ…‹æ¡†
        setTimeout(() => {
            this.showGameOverModal(true, score);
            this.saveScore(score);
        }, 1500);
    }
    
    giveUp() {
        if (this.gameOver || this.attempts === 0) return;
        
        this.gameOver = true;
        document.getElementById('guessInput').disabled = true;
        document.getElementById('submitGuess').disabled = true;
        
        this.showGameOverModal(false, 0);
    }
    
    showGameOverModal(won, score) {
        const modal = new bootstrap.Modal(document.getElementById('gameOverModal'));
        const modalHeader = document.getElementById('modalHeader');
        const modalTitle = document.getElementById('modalTitle');
        const resultMessage = document.getElementById('resultMessage');
        const scoreRating = document.getElementById('scoreRating');
        
        document.getElementById('correctAnswer').textContent = this.targetNumber;
        document.getElementById('finalAttempts').textContent = this.attempts;
        document.getElementById('finalScore').textContent = score;
        
        if (won) {
            modalHeader.className = 'modal-header bg-success text-white';
            modalTitle.textContent = 'ğŸ‰ æ­å–œç²å‹ï¼';
            resultMessage.innerHTML = '<h5 class="text-success">ä½ æˆåŠŸçŒœå‡ºäº†æ•¸å­—ï¼</h5>';
            
            // è©•åƒ¹ç³»çµ±
            let rating = '';
            if (this.attempts === 1) {
                rating = '<div class="badge bg-warning fs-6">ğŸ¯ ç¥å°„æ‰‹ï¼</div>';
            } else if (this.attempts <= 3) {
                rating = '<div class="badge bg-success fs-6">ğŸ† å„ªç§€ï¼</div>';
            } else if (this.attempts <= 7) {
                rating = '<div class="badge bg-info fs-6">ğŸ‘ ä¸éŒ¯ï¼</div>';
            } else if (this.attempts <= 10) {
                rating = '<div class="badge bg-secondary fs-6">ğŸ˜Š é‚„è¡Œï¼</div>';
            } else {
                rating = '<div class="badge bg-danger fs-6">ğŸ˜… éœ€è¦ç·´ç¿’ï¼</div>';
            }
            scoreRating.innerHTML = rating;
        } else {
            modalHeader.className = 'modal-header bg-danger text-white';
            modalTitle.textContent = 'ğŸ˜¢ éŠæˆ²çµæŸ';
            resultMessage.innerHTML = '<h5 class="text-danger">å¾ˆéºæ†¾ï¼Œä½ æ”¾æ£„äº†ï¼</h5>';
            scoreRating.innerHTML = '<div class="badge bg-secondary fs-6">ä¸‹æ¬¡å†è©¦è©¦å§ï¼</div>';
        }
        
        modal.show();
    }
    
    calculateScore() {
        // åˆ†æ•¸è¨ˆç®—ï¼šåŸºç¤åˆ†æ•¸ 1010ï¼Œæ¯æ¬¡å˜—è©¦æ‰£ 10 åˆ†
        return Math.max(0, 1010 - this.attempts * 10);
    }
    
    showHint(message, type) {
        const hintMessage = document.getElementById('hintMessage');
        hintMessage.textContent = message;
        hintMessage.className = `alert alert-${type}`;
        hintMessage.style.display = 'block';
    }
    
    updateUI() {
        document.getElementById('attempts').textContent = this.attempts;
        document.getElementById('range').textContent = `${this.minRange}-${this.maxRange}`;
    }
    
    updateBestScore() {
        document.getElementById('bestScore').textContent = this.bestScore > 0 ? this.bestScore : '-';
    }
    
    updateHistory() {
        const historyArea = document.getElementById('historyArea');
        const historyContainer = document.getElementById('guessHistory');
        
        if (this.guessHistory.length > 0) {
            historyArea.style.display = 'block';
            historyContainer.innerHTML = '';
            
            this.guessHistory.forEach((guess, index) => {
                const badge = document.createElement('span');
                badge.textContent = guess.number;
                badge.style.margin = '2px'; // æ·»åŠ é–“è·
                
                if (guess.result === 'correct') {
                    badge.className = 'badge bg-success';
                } else if (guess.result === 'high') {
                    badge.className = 'badge bg-danger';
                } else {
                    badge.className = 'badge bg-info';
                }
                
                historyContainer.appendChild(badge);
            });
        }
    }
    
    loadBestScore() {
        const saved = localStorage.getItem('guessNumberBestScore');
        return saved ? parseInt(saved) : 0;
    }
    
    saveBestScore(score) {
        localStorage.setItem('guessNumberBestScore', score.toString());
    }
    
    saveScore(score) {
        fetch('/game/save_score', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                game_type: 'guess_number',
                score: score,
                level: 1,
                attempts: this.attempts
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('åˆ†æ•¸å„²å­˜çµæœ:', data);
        })
        .catch(error => {
            console.error('å„²å­˜åˆ†æ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        });
    }
}

// åˆå§‹åŒ–éŠæˆ²
document.addEventListener('DOMContentLoaded', function() {
    new GuessNumberGame();
});
</script>
{% endblock %}